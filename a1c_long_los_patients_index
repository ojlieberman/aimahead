# Optional: write long_los_patients_index to database
dbWriteTable(conn, "long_los_index_temp", long_los_patients_index, temporary = TRUE, overwrite = TRUE)

query <- "
WITH filtered_measurements AS (
  SELECT
    m.person_id,
    m.measurement_datetime,
    m.value_as_number,
    m.unit_concept_id
  FROM omopcdm.measurement m
  WHERE m.measurement_concept_id = 3004410
    AND m.value_as_number > 4 AND m.value_as_number < 20
),
joined_data AS (
  SELECT
    los.person_id,
    los.visit_start_datetime,
    los.src_name,
    fm.measurement_datetime,
    fm.value_as_number,
    fm.unit_concept_id
  FROM long_los_index_temp los
  JOIN filtered_measurements fm ON los.person_id = fm.person_id
  WHERE fm.measurement_datetime BETWEEN los.visit_start_datetime - INTERVAL '5 days'
                                     AND los.visit_start_datetime + INTERVAL '5 days'
),
summarized_a1c AS (
  SELECT
    person_id,
    visit_start_datetime,
    src_name,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY value_as_number)::double precision AS a1c_median,
    MIN(unit_concept_id) AS a1c_unit_concept_id,
    MIN(measurement_datetime) AS a1c_measurement_datetime
  FROM joined_data
  GROUP BY person_id, visit_start_datetime, src_name
)

SELECT * FROM summarized_a1c;
"

a1c_long_los_patients_index <- dbGetQuery(conn, query)
